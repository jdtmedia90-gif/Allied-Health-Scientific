<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Allied Health Scientific</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="logo-container">
    <h1>Allied Health Scientific</h1>
  </div>
  <nav class="toolbar">
    <a href="about.html">About Us</a>
    <a href="contact.html">Contact</a>
  </nav>
  <input type="text" id="search" placeholder="Search products...">
  <select id="category-filter">
    <option value="">All</option>
  </select>
  <button id="cart-btn">Cart (<span id="cart-count">0</span>)</button>
</header>

<main>
  <div id="product-list"></div>
</main>

<div id="cart-panel">
  <button id="close-cart">Close</button>
  <h2>Your Cart</h2>
  <div id="cart-items"></div>
  <p>Subtotal: $<span id="cart-subtotal">0.00</span></p>

  <form id="checkoutForm">
    <input type="hidden" name="cartData" id="cartData">
    <label>Name</label><input type="text" name="customerName" required>
    <label>Email</label><input type="email" name="customerEmail" required>
    <label>Phone</label><input type="text" name="customerPhone" required>
    <button type="submit">Checkout</button>
    <p id="status"></p>
  </form>
</div>

<section id="contact">
  <h2>Contact Us</h2>
  <p>Email: <a href="mailto:tesecumj@gmail.com">tesecumj@gmail.com</a></p>
  <p>WhatsApp: <a href="https://wa.me/15016029197" target="_blank">+501 602-9197</a></p>
</section>

<div id="lightbox" class="hidden">
  <span id="close">&times;</span>
  <img id="lightbox-img" src="" alt="Product Image">
</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1gDRKAFFNtFlox6OyG8fr6y5PMRahFQLy_TQzXatJtwo/gviz/tq?tqx=out:json";
const APP_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_APP_SCRIPT_ID/exec";

let products = [];
let cart = JSON.parse(localStorage.getItem("site_cart_v1")) || [];

// --- PRODUCT LOADING FROM SHEET ---
async function loadProducts() {
  try {
    const res = await fetch(sheetURL);
    const text = await res.text();
    const jsonData = JSON.parse(text.substring(47).slice(0, -2));
    const rows = jsonData.table.rows;

    products = rows.slice(1).map((r,i)=>({
      id: r.c[0]?.v?.toString() || "p"+i,
      name: r.c[0]?.v || "Unnamed",
      category: r.c[1]?.v || "",
      price: parseFloat(r.c[2]?.v) || 0,
      desc: r.c[3]?.v || "",
      image: r.c[4]?.v || ""
    }));

    populateCategoryFilter();
    displayProducts(products);
    updateCartCount();
  } catch(err) {
    console.error("Error loading products:", err);
    document.getElementById("product-list").innerHTML="<p>Failed to load products.</p>";
  }
}

function displayProducts(list){
  const container = document.getElementById("product-list");
  container.innerHTML = list.map(p=>`
    <div class="product" data-category="${p.category}">
      ${p.image ? `<img src="${p.image}" alt="${p.name}">` : ""}
      <h3>${p.name}</h3>
      <p class="desc">${p.desc}</p>
      <p class="price">$${p.price.toFixed(2)}</p>
      <div class="qty-box">
        <label>Qty:</label>
        <input type="number" min="1" value="1" id="qty-${p.id}">
      </div>
      <button onclick="addToCartFromInput('${p.id}')">Add to Cart</button>
    </div>
  `).join("");

  document.querySelectorAll(".product img").forEach(img=>{
    img.addEventListener("click", ()=>openLightbox(img.src));
  });
}

function addToCartFromInput(id){
  const product = products.find(p=>p.id===id);
  const qtyInput = document.getElementById(`qty-${id}`);
  let qty = parseInt(qtyInput.value);
  if(!qty || qty<1) qty=1;

  const existing = cart.find(i=>i.id===id);
  if(existing) existing.qty+=qty;
  else cart.push({...product, qty});
  saveCart();
}

function saveCart(){
  localStorage.setItem("site_cart_v1", JSON.stringify(cart));
  renderCart();
  updateCartCount();
}

function updateCartCount(){
  const count = cart.reduce((s,i)=>s+(i.qty||0),0);
  document.getElementById("cart-count").textContent=count;
}

function cartSubtotal(){
  return cart.reduce((s,i)=>s+(i.price||0)*(i.qty||0),0);
}

function renderCart(){
  const el = document.getElementById("cart-items");
  if(cart.length===0){ el.innerHTML="<p>Your cart is empty.</p>"; document.getElementById("cart-subtotal").textContent="0.00"; return; }
  el.innerHTML = cart.map(item=>`
    <div class="cart-item">
      ${item.image ? `<img src="${item.image}" alt="${item.name}">` : ""}
      <div class="meta">
        <h4>${item.name}</h4>
        <div class="price">$${item.price.toFixed(2)}</div>
      </div>
      <div class="actions">
        <input type="number" min="1" value="${item.qty}" data-id="${item.id}" class="qty-input">
        <button class="remove-item" data-id="${item.id}">Remove</button>
      </div>
    </div>
  `).join("");
  document.getElementById("cart-subtotal").textContent = cartSubtotal().toFixed(2);

  document.querySelectorAll(".qty-input").forEach(input=>{
    input.addEventListener("change", e=>{
      const id = e.currentTarget.dataset.id;
      const qty = Math.max(1, parseInt(e.currentTarget.value)||1);
      const item = cart.find(i=>i.id===id);
      if(item) item.qty=qty;
      saveCart();
    });
  });

  document.querySelectorAll(".remove-item").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const id = e.currentTarget.dataset.id;
      cart = cart.filter(i=>i.id!==id);
      saveCart();
    });
  });
}

const cartBtn = document.getElementById("cart-btn");
const cartPanel = document.getElementById("cart-panel");
const closeCart = document.getElementById("close-cart");
cartBtn.addEventListener("click", ()=>cartPanel.classList.add("open"));
closeCart.addEventListener("click", ()=>cartPanel.classList.remove("open"));

document.getElementById("category-filter").addEventListener("change", e=>{
  const cat = e.target.value;
  const filtered = cat ? products.filter(p=>p.category===cat) : products;
  displayProducts(filtered);
});

document.getElementById("search").addEventListener("input", e=>{
  const term = e.target.value.toLowerCase();
  const filtered = products.filter(p=>p.name.toLowerCase().includes(term) || p.desc.toLowerCase().includes(term) || p.category.toLowerCase().includes(term));
  displayProducts(filtered);
});

function populateCategoryFilter(){
  const select = document.getElementById("category-filter");
  select.innerHTML='<option value="">All</option>';
  const categories = [...new Set(products.map(p=>p.category).filter(c=>c))];
  categories.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c;
    opt.textContent=c;
    select.appendChild(opt);
  });
}

function openLightbox(src){
  document.getElementById("lightbox").classList.remove("hidden");
  document.getElementById("lightbox-img").src=src;
}
document.getElementById("close").addEventListener("click",()=>document.getElementById("lightbox").classList.add("hidden"));

// --- CHECKOUT SUBMISSION USING FETCH ---
document.getElementById("checkoutForm").addEventListener("submit", async e=>{
  e.preventDefault();
  document.getElementById("status").textContent="Submitting...";
  const formData = {
    customerName: e.target.customerName.value,
    customerEmail: e.target.customerEmail.value,
    customerPhone: e.target.customerPhone.value,
    cartData: cart
  };

  try{
    const res = await fetch(APP_SCRIPT_URL, {
      method:"POST",
      body: JSON.stringify(formData)
    });
    if(res.ok){
      document.getElementById("status").textContent="Order submitted successfully!";
      cart=[];
      saveCart();
    } else {
      document.getElementById("status").textContent="Error submitting order.";
    }
  } catch(err){
    document.getElementById("status").textContent="Error submitting order.";
    console.error(err);
  }
});

// --- INITIAL LOAD ---
loadProducts();
renderCart();
updateCartCount();
</script>
</body>
</html>
